<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê°€ê²© ê³„ì‚° í…ŒìŠ¤íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="calendar_set/full_ver7/env.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .test-result { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .correct { background: #e8f5e9; border-color: #4caf50; }
    .wrong { background: #ffebee; border-color: #f44336; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; }
  </style>
</head>
<body>
  <h1>ê°€ê²© ê³„ì‚° í…ŒìŠ¤íŠ¸</h1>
  <p>Supabaseì—ì„œ ì‹¤ì œ ì´ë²¤íŠ¸ë¥¼ ê°€ì ¸ì™€ì„œ ë¡œì»¬ì—ì„œ ê°€ê²©ì„ ì¬ê³„ì‚°í•©ë‹ˆë‹¤.</p>
  
  <button onclick="testPricing()">ê°€ê²© ì¬ê³„ì‚° í…ŒìŠ¤íŠ¸</button>
  <button onclick="fixAllPrices()">ğŸ”§ ì „ì²´ ê°€ê²© ìˆ˜ì • (ì£¼ì˜!)</button>
  
  <div id="results"></div>
  
  <script>
    const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    
    // ê°€ê²© ê³„ì‚° í•¨ìˆ˜ (price-calculator.jsì™€ ë™ì¼í•œ ë¡œì§)
    const ROOM_PRICES = {
      a: { before16: 10000, after16: 13000, overnight: 30000 },
      b: { before16: 9000, after16: 11000, overnight: 20000 },
      c: { before16: 4000, after16: 6000, overnight: 15000 },
      d: { before16: 3000, after16: 5000, overnight: 15000 },
      e: { before16: 8000, after16: 10000, overnight: 20000 }
    };
    
    const KOREAN_HOLIDAYS_2025 = [
      '2025-01-01', '2025-01-28', '2025-01-29', '2025-01-30',
      '2025-03-01', '2025-03-03', '2025-05-05', '2025-05-06',
      '2025-06-06', '2025-08-15', '2025-09-06', '2025-09-07',
      '2025-09-08', '2025-09-09', '2025-10-03', '2025-10-09',
      '2025-12-25'
    ];
    
    function toKst(date) {
      return new Date(date.getTime() + 9 * 60 * 60 * 1000);
    }
    
    function getKstHour(date) {
      return toKst(date).getUTCHours();
    }
    
    function getKstDay(date) {
      return toKst(date).getUTCDay();
    }
    
    function getKstDateString(date) {
      return toKst(date).toISOString().split('T')[0];
    }
    
    function isWeekendOrHoliday(date) {
      const day = getKstDay(date);
      const dateString = getKstDateString(date);
      return day === 0 || day === 6 || KOREAN_HOLIDAYS_2025.includes(dateString);
    }
    
    function calculatePrice(startTime, endTime, roomId, description = '') {
      const start = new Date(startTime);
      const end = new Date(endTime);
      const prices = ROOM_PRICES[roomId];
      
      if (!prices) return { price: 0, priceType: 'unknown', isNaver: false };
      
      let totalPrice = 0;
      let priceType = 'ì¼ë°˜';
      const isNaver = /ì˜ˆì•½ë²ˆí˜¸:\s*\d+/.test(description || '');
      
      const startHourKst = getKstHour(start);
      const endHourKst = getKstHour(end);
      const durationHours = (end - start) / (1000 * 60 * 60);
      
      if (startHourKst === 0 && endHourKst === 6 && durationHours === 6) {
        totalPrice = prices.overnight;
        priceType = 'ìƒˆë²½í†µëŒ€ê´€';
      } else {
        let currentTime = new Date(start);
        
        while (currentTime < end) {
          const hourKst = getKstHour(currentTime);
          
          if (hourKst >= 0 && hourKst < 6) {
            totalPrice += prices.overnight / 6;
          } else if (isWeekendOrHoliday(currentTime)) {
            totalPrice += prices.after16;
          } else {
            totalPrice += hourKst < 16 ? prices.before16 : prices.after16;
          }
          
          currentTime.setHours(currentTime.getHours() + 1);
        }
        
        if (startHourKst >= 0 && startHourKst < 6) priceType = 'ìƒˆë²½';
        else if (isWeekendOrHoliday(start)) priceType = 'ì£¼ë§/ê³µíœ´ì¼';
        else if (startHourKst >= 16) priceType = 'ì €ë…';
        else priceType = 'ì¼ë°˜';
      }
      
      totalPrice = Math.round(totalPrice * (isNaver ? 0.9802 : 0.9));
      
      return { price: totalPrice, priceType, isNaver };
    }
    
    async function testPricing() {
      const results = document.getElementById('results');
      results.innerHTML = '<p>ë¡œë”© ì¤‘...</p>';
      
      // Dí™€ ì•„ì¹¨ 9~10ì‹œ ì´ë²¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
      const { data: events, error } = await supabase
        .from('booking_events')
        .select('*')
        .eq('room_id', 'd')
        .limit(20)
        .order('start_time', { ascending: false });
      
      if (error) {
        results.innerHTML = `<p style="color: red;">ì˜¤ë¥˜: ${error.message}</p>`;
        return;
      }
      
      let html = `<h2>í…ŒìŠ¤íŠ¸ ê²°ê³¼ (Dí™€ ìµœê·¼ 20ê°œ)</h2>`;
      let wrongCount = 0;
      
      events.forEach(event => {
        const calculated = calculatePrice(event.start_time, event.end_time, event.room_id, event.description);
        const stored = event.price;
        const match = calculated.price === stored;
        
        if (!match) wrongCount++;
        
        const startKst = new Date(new Date(event.start_time).getTime() + 9 * 60 * 60 * 1000);
        
        html += `
          <div class="test-result ${match ? 'correct' : 'wrong'}">
            <strong>${event.title}</strong><br>
            ì‹œì‘: ${startKst.toLocaleString('ko-KR')}<br>
            DB ì €ì¥ê°’: ${(stored || 0).toLocaleString()}ì› | 
            ì¬ê³„ì‚°ê°’: ${calculated.price.toLocaleString()}ì› | 
            ${match ? 'âœ… ì¼ì¹˜' : 'âŒ ë¶ˆì¼ì¹˜'}<br>
            íƒ€ì…: ${calculated.priceType}
          </div>
        `;
      });
      
      html = `<p><strong>ì´ ${events.length}ê°œ ì¤‘ ${wrongCount}ê°œ ë¶ˆì¼ì¹˜</strong></p>` + html;
      results.innerHTML = html;
    }
    
    async function fixAllPrices() {
      if (!confirm('ì „ì²´ ì´ë²¤íŠ¸ì˜ ê°€ê²©ì„ ì¬ê³„ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)')) return;
      
      const results = document.getElementById('results');
      results.innerHTML = '<p>ì „ì²´ ê°€ê²© ì¬ê³„ì‚° ì¤‘...</p>';
      
      let from = 0;
      const batchSize = 100;
      let totalUpdated = 0;
      
      while (true) {
        const { data: events, error } = await supabase
          .from('booking_events')
          .select('*')
          .order('start_time', { ascending: true })
          .range(from, from + batchSize - 1);
        
        if (error || !events || events.length === 0) break;
        
        for (const event of events) {
          const { price, priceType, isNaver } = calculatePrice(
            event.start_time,
            event.end_time,
            event.room_id,
            event.description
          );
          
          await supabase
            .from('booking_events')
            .update({ price, price_type: priceType, is_naver: isNaver })
            .eq('id', event.id);
          
          totalUpdated++;
        }
        
        results.innerHTML = `<p>${totalUpdated}ê°œ ì—…ë°ì´íŠ¸ ì¤‘...</p>`;
        
        if (events.length < batchSize) break;
        from += batchSize;
      }
      
      results.innerHTML = `<h2>âœ… ì™„ë£Œ!</h2><p>ì´ ${totalUpdated}ê°œ ì´ë²¤íŠ¸ ê°€ê²© ì¬ê³„ì‚° ì™„ë£Œ</p>`;
    }
  </script>
</body>
</html>
