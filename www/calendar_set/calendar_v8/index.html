<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    
    <!-- URL 정규화: index.html이 포함된 경우 디렉토리 경로로 리디렉션 -->
    <script>
      (function() {
        var currentPath = window.location.pathname;
        var search = window.location.search;
        var hash = window.location.hash;
        
        // URL에 index.html이 포함되어 있는지 확인
        if (currentPath.endsWith('/index.html')) {
          // index.html 제거한 디렉토리 경로 생성
          var newPath = currentPath.replace('/index.html', '/');
          var newUrl = newPath + search + hash;
          
          // 리디렉션 (replace 사용으로 브라우저 히스토리에 중복 기록 방지)
          window.location.replace(newUrl);
        }
      })();
    </script>

    <title>리듬앤조이 일정표</title>

    <!-- PWA 설치 비활성화 -->
    <!-- <link rel="manifest" href="manifest.json" /> -->
    <link rel="apple-touch-icon" href="img/logo.png" />

    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="css/calendar.css" />
    <link rel="stylesheet" href="home_infopage/popup.css" />
  </head>
  <body>
    <!-- 팝업 배경 -->
    <div id="popupOverlay" class="popup-overlay"></div>

    <!-- 팝업 박스 -->
    <div id="popupBox" class="popup">
      <div id="popupContent"></div>
    </div>

    <!-- 내부 팝업용 오버레이 -->
    <div
      id="innerPopupOverlay"
      class="popup-overlay"
      style="z-index: 10002"
    ></div>

    <!-- 내부 팝업 박스 -->
    <div id="innerPopupBox" class="popup" style="z-index: 10003">
      <div id="innerPopupContent"></div>
    </div>

    <!-- 왼쪽 메뉴 iframe (데스크탑) -->
    <iframe
      id="leftMenuFrame"
      src="left-menu.html"
      style="display: none"
    ></iframe>

    <!-- 왼쪽 메뉴 (모바일 오프캔버스) -->
    <div
      class="offcanvas offcanvas-start text-bg-dark"
      tabindex="-1"
      id="leftMenu"
      aria-labelledby="leftMenuLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="leftMenuLabel">메뉴</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>

      <!-- 모바일용 메뉴 iframe -->
      <div class="offcanvas-body" style="padding: 0">
        <iframe
          src="left-menu.html"
          style="width: 100%; height: 100%; border: none"
        ></iframe>
      </div>
    </div>

    <!-- 오른쪽 iframe -->
    <iframe
      id="sideFrame"
      src="https://voluble-mochi-a91544.netlify.app/"
      style="display: none"
    ></iframe>

    <!-- 예약정보 페이지 오버레이 -->
    <div id="infoPageOverlay" class="info-page-overlay">
      <iframe id="infoPageFrame" class="info-page-frame" src="./home_infopage/homepage-section_mobile.html"></iframe>
    </div>

    <div class="app-container">
      <header class="calendar-header">
        <div class="month-nav-group">
          <button class="month-nav-btn" id="prevMonthBtn" title="이전 달">
            ◀
          </button>
          <h1 class="calendar-title" id="calendarTitle">11월</h1>
          <button class="month-nav-btn" id="nextMonthBtn" title="다음 달">
            ▶
          </button>
        </div>

        <button class="admin-btn" id="adminBtn" title="관리자 모드">⚙️</button>
      </header>

      <main class="calendar-main" id="calendarContainer">
        <div class="loading">로딩 중...</div>
      </main>

      <footer class="bottom-controls">
        <div class="logo-section">
          <div class="logo-circle">
            <img
              src="img/logo.png"
              alt="리듬앤조이"
              style="width: 100%; height: 100%; object-fit: cover"
            />
          </div>
          <span class="logo-text">리듬앤조이 연습실</span>
        </div>

        <button class="info-btn" id="infoBtn"><span>▼</span> 예약 정보</button>
      </footer>

      <nav class="room-selector">
        <button
          class="room-btn active"
          data-room="a"
          style="background-color: #f6bf26"
        >
          A
        </button>
        <button
          class="room-btn active"
          data-room="b"
          style="background-color: rgb(87, 150, 200)"
        >
          B
        </button>
        <button
          class="room-btn active"
          data-room="c"
          style="background-color: rgb(129, 180, 186)"
        >
          C
        </button>
        <button
          class="room-btn active"
          data-room="d"
          style="background-color: rgb(125, 157, 106)"
        >
          D
        </button>
        <button
          class="room-btn active"
          data-room="e"
          style="background-color: #4c4c4c; color: #fff"
        >
          E
        </button>
        <button class="room-btn" id="allRoomsBtn">ALL</button>
        <div class="week-nav">
          <button class="period-btn active">월</button>
          <button class="period-btn">주</button>
          <button class="nav-btn-round" id="prevWeekBtn">&lt;</button>
          <button class="today-btn" id="todayBtn">오늘</button>
          <button class="nav-btn-round-right" id="nextWeekBtn">&gt;</button>
        </div>
      </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // 원본 console 먼저 저장 (오버라이드 전)
      window._originalConsole = {
        log: console.log.bind(console),
        error: console.error.bind(console),
        warn: console.warn.bind(console),
        info: console.info.bind(console),
        table: console.table ? console.table.bind(console) : console.log.bind(console)
      };
      
      // Logger 클래스 - Supabase DB + localStorage 저장
      class Logger {
        constructor() {
          this.logs = [];
          this.maxLogs = 500; // ERROR만: 5일 × ~100개/일 ≈ 500개
          this.logKey = 'rhythmjoy_logs';
          this.maxAge = 5 * 24 * 60 * 60 * 1000; // 5일 (밀리초)
          this.supabase = null;
          this.loadLogs();
          this.initSupabase();
        }
        
        initSupabase() {
          // Supabase 클라이언트 초기화 (프론트엔드에서 직접 사용)
          if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
            this.supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
          }
        }
        
        loadLogs() {
          try {
            const stored = localStorage.getItem(this.logKey);
            if (stored) this.logs = JSON.parse(stored);
          } catch(e) {
            window._originalConsole.error('로그 로드 실패:', e);
          }
        }
        
        saveLogs() {
          try {
            // ERROR 레벨만 필터링
            let errorLogs = this.logs.filter(log => log.level === 'ERROR');
            
            // 5일 이상 된 로그 제거
            const now = Date.now();
            errorLogs = errorLogs.filter(log => {
              const logTime = new Date(log.timestamp).getTime();
              return (now - logTime) < this.maxAge;
            });
            
            // 최대 개수 제한
            if (errorLogs.length > this.maxLogs) {
              errorLogs = errorLogs.slice(-this.maxLogs);
            }
            
            localStorage.setItem(this.logKey, JSON.stringify(errorLogs));
          } catch(e) {
            window._originalConsole.error('로그 저장 실패:', e);
          }
        }
        
        // Supabase로 로그 저장 (비동기)
        async sendToSupabase(level, message, data) {
          try {
            if (!this.supabase) return;
            
            const { error } = await this.supabase
              .from('logs')
              .insert([{
                level,
                message,
                data,
                user_agent: navigator.userAgent,
                url: window.location.href
              }]);
            
            if (error) {
              window._originalConsole.error(`로그 저장 실패:`, error.message);
            }
          } catch(e) {
            // 네트워크 오류는 무시
          }
        }
        
        log(level, message, data = null) {
          const entry = {
            timestamp: new Date().toISOString(),
            level,
            message,
            data
          };
          
          // 메모리에 저장
          this.logs.push(entry);
          this.saveLogs();
          
          // Supabase로 비동기 저장 (오류 무시)
          this.sendToSupabase(level, message, data);
          
          // 무한루프 방지: _originalConsole 직접 사용
          if (level === 'ERROR') {
            window._originalConsole.error(`[${level}] ${message}`, data || '');
          }
        }
        
        error(message, data = null) { this.log('ERROR', message, data); }
        warn(message, data = null) { this.log('WARN', message, data); }
        info(message, data = null) { this.log('INFO', message, data); }
        
        getLogs(level = null, limit = 100) {
          let filtered = level 
            ? this.logs.filter(log => log.level === level)
            : this.logs;
          return filtered.slice(-limit);
        }
        
        clear() {
          this.logs = [];
          localStorage.removeItem(this.logKey);
        }
        
        download() {
          const content = this.logs.map(log => 
            `[${log.timestamp}] ${log.level}: ${log.message}${log.data ? '\n  ' + JSON.stringify(log.data) : ''}`
          ).join('\n');
          const blob = new Blob([content], {type: 'text/plain'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `rhythmjoy-logs-${new Date().toISOString().slice(0,10)}.txt`;
          a.click();
          URL.revokeObjectURL(url);
        }
      }
      
      window.logger = new Logger();
      
      window.downloadLogs = function() { window.logger.download(); };
      window.viewLogs = function(level) {
        const logs = window.logger.getLogs(level, 50);
        if (logs.length === 0) {
          window._originalConsole.log('로그가 없습니다.');
        } else {
          window._originalConsole.table(logs);
        }
      };
      window.clearLogs = function() {
        window.logger.clear();
        window._originalConsole.log('로그가 삭제되었습니다.');
      };
    </script>

    <script src="env.js"></script>
    <script src="js/config.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/calendar-core.js"></script>
    <script src="js/main.js"></script>
    <script src="home_infopage/open_popup.js"></script>

    <script>
      // 연락처 복사 함수
      function copy() {
        var copyTxt = document.getElementById("copyTxt");
        copyTxt.select();
        copyTxt.setSelectionRange(0, 99999);

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(copyTxt.value)
            .then(() => {
              alert("010-4801-7180 복사되었습니다.");
              copyTxt.blur();
            })
            .catch((err) => {
              if (window.logger) logger.error("복사 실패", { error: err });
              alert("복사에 실패했습니다.");
            });
        } else {
          try {
            document.execCommand("copy");
            alert("010-4801-7180 복사되었습니다.");
            copyTxt.blur();
          } catch (err) {
            if (window.logger) logger.error("복사 실패", { error: err });
            alert("복사에 실패했습니다. 수동으로 복사해주세요.");
          }
        }
      }
    </script>
  </body>
</html>
